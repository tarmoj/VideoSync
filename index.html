<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Sync Video</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script> 
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #1a1a1a; color: #eee; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        #qrcode { background: white; padding: 10px; display: inline-block; margin: 20px; border-radius: 8px; }
        #reader { width: 100%; max-width: 400px; margin: auto; border: 1px solid #555; }
        video { width: 100%; border-radius: 12px; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn { padding: 12px 24px; font-size: 16px; border: none; border-radius: 25px; cursor: pointer; margin: 5px; transition: 0.3s; }
        .btn-host { background: #00c853; color: white; }
        .btn-join { background: #2979ff; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>P2P Video Sync 0.2.0</h2>
    
    <div id="setup-ui">
        <button class="btn btn-host" onclick="startAsHost()">Be the Host (Show QR)</button>
        <button class="btn btn-join" onclick="startAsClient()">Join Session (Scan QR)</button>
    </div>

    <div id="host-ui" class="hidden">
        <p>Scan this with the other tablet:</p>
        <div id="qrcode"></div>
        <p>ID: <span id="my-id">...</span></p>
    </div>

    <div id="client-ui" class="hidden">
        <div id="reader"></div>
        <p>Pointing your camera at the Host's QR code...</p>
    </div>

    <video id="sync-video" controls preload="auto">
        <source src="./smjorRennsli1.mp4" type="video/mp4">
    </video>
    
    <p id="status" style="margin-top:20px; color: #ffab00;"></p>
</div>

<script>
    const video = document.getElementById('sync-video');
    const status = document.getElementById('status');
    let peer = null; 
    let conn = null;
    let latency = 0;

    function measureLatency() {
        if (!conn || !conn.open) return;
        
        const start = performance.now();
        // Send a ping to the other peer
        conn.send({ type: 'PING', sentAt: start });
    }

    // --- HOST LOGIC ---
    function startAsHost() {
        document.getElementById('setup-ui').classList.add('hidden');
        document.getElementById('host-ui').classList.remove('hidden');
        peer = new Peer();

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
            console.log("Peer ID:", id);
            new QRCode(document.getElementById("qrcode"), id); // Generate QR
        });

        peer.on('connection', (connection) => {
            conn = connection;
            initSync();
            status.innerText = "Syncing with Client...";
        });
    }

    // --- CLIENT LOGIC ---
    function startAsClient() {
        document.getElementById('setup-ui').classList.add('hidden');
        document.getElementById('client-ui').classList.remove('hidden');

        peer = new Peer();

        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
                // When QR is scanned:
                html5QrCode.stop();
                document.getElementById('client-ui').classList.add('hidden');
                console.log("Decoded QR:", decodedText);
                conn = peer.connect(decodedText);
                initSync();
                status.innerText = "Connected to Host!";
            }
        ).catch(err => console.error("Camera error:", err));
    }

    // --- SYNC CORE ---
    function initSync() {
        conn.on('data', (data) => {
            if (data.type === 'PING') {
                conn.send({ type: 'PONG', sentAt: data.sentAt });
            } 
            else if (data.type === 'PONG') {
                const end = performance.now();
                latency = (end - data.sentAt) / 2 / 1000; // Convert to seconds
                console.log(`Measured Latency: ${latency.toFixed(3)}s`);
            } 
            else if (data.type === 'SYNC') {
                // Apply the latency compensation!
                const adjustedTargetTime = data.time + latency;
                const diff = Math.abs(video.currentTime - adjustedTargetTime);

                if (diff > 0.5) {
                    // Large drift: Hard jump
                    video.currentTime = adjustedTargetTime;
                } else if (diff > 0.05) {
                    // Tiny drift: Slightly speed up/slow down to catch up (transparent to user)
                    video.playbackRate = (video.currentTime < adjustedTargetTime) ? 1.05 : 0.95;
                } else {
                    video.playbackRate = 1.0;
                }

                data.playing ? video.play() : video.pause();
            }
        });

        // const sync = () => {
        //     if (conn && conn.open) {
        //         conn.send({ type: 'SYNC', time: video.currentTime, playing: !video.paused });
        //     }
        // };
        
        // 2. Start heartbeat to keep latency data fresh
        setInterval(measureLatency, 3000);

        // 3. Broadcast changes
        const broadcast = () => {
            if (conn && conn.open) {
                conn.send({ 
                    type: 'SYNC', 
                    time: video.currentTime, 
                    playing: !video.paused 
                });
            }
        };

        video.onplay = broadcast;
        video.onpause = broadcast;
        video.onseeking = broadcast;
    
    }
</script>
</body>
</html>